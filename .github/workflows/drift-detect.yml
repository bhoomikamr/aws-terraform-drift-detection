name: 'Drift Detector'

on:
    schedule:
        - cron: "0 8 * * *"

    workflow_dispatch:
    

permissions:

    contents: read
    issues: write

jobs:
    drift_checker:

        runs-on: ubuntu-latest
        
        steps:

        - name: Code checkout
          uses: actions/checkout@v4

        - name: AWS login
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
            aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
            aws-region: us-east-1
        
        - name: Terraform setup
          uses: hashicorp/setup-terraform@v3
          
      
        - name: Drift check
          id: drift_check
          continue-on-error: true 
          working-directory: ./terraform
          run: |
            terraform init
            terraform plan -detailed-exitcode
            # Capture the exit code of the plan command specifically
            # echo "plan_exit_code=$?" >> $GITHUB_OUTPUT

        - name: Open GitHub issue if drift present
          # Check for exit code 2 (Drift) or 1 (Error)
          if: steps.drift_check.outputs.exitcode == '2'
          run: |
            gh issue create \
            --title "Infrastructure drift detected" \
            --body "Drift detected by Terraform plan. Manual intervention required."
          env:
            GH_TOKEN: ${{ github.token }}

            




